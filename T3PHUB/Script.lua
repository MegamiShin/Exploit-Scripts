--We currently only support Synapse and SW, so we add a quick check.
local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")

local LocalPlayer = Players.LocalPlayer

local isSW = false
local IsKRNL = false

if getexecutorname and type(getexecutorname) == "function" then
	executorName = getexecutorname() -- string response, use eq statement
	if executorName == "ScriptWare" then
		isSW = true
	end
end

if Krnl then
	IsKRNL = true
end

if not syn and not isSW and not IsKRNL then
	game.Players.LocalPlayer:Kick(
		"Hey! Thanks for your interest in T3PHUB, sadly, currently we only support Synapse, Script-Ware and Krnl. Check back later! You will now be rejoined."
	)
	wait(5)
	TeleportService:Teleport(game.PlaceId, LocalPlayer)
else
	--Check if T3PHUB is already loaded.
	if game.CoreGui:FindFirstChild("T3PHUBLoaded") then
		error("T3PHUB is already loaded, if you encounter any issues, please rejoin and try again!")
	else
		--Services
		local CoreGui = game.CoreGui

		--Instances

		--Properties
		local PlaceID = game.PlaceId

		--Information
		local ScriptBase64 =
			"LS1IZXkhIFRoaXMgZmlsZSBpcyBoZXJlIGluIGNhc2UgeW91IGxvc3QgdGhlIHNjcmlwdCwgaWYgdGhhdCBoYXBwZW5lZCwganVzdCBjb3B5IHRoZSBjb250ZW50cyBvZiB0aGlzIGZpbGUgYW5kIHRoYXQncyB0aGUgc2NyaXB0IQpsb2Fkc3RyaW5nKGdhbWU6SHR0cEdldCJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vTWVnYW1pU2hpbi9FeHBsb2l0LVNjcmlwdHMvbWFpbi9UM1BIVUIvU2NyaXB0Lmx1YSIpKCk="
		local DecodedScript = "An error occured!"

        local ScriptBase64Raw = "bG9hZHN0cmluZyhnYW1lOkh0dHBHZXQiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL01lZ2FtaVNoaW4vRXhwbG9pdC1TY3JpcHRzL21haW4vVDNQSFVCL1NjcmlwdC5sdWEiKSgp"
		local DecodedScript2 = "An error occured!"

        if isSW == true then
			DecodedScript = crypt.base64decode(ScriptBase64)
            DecodedScript2 = crypt.base64decode(ScriptBase64Raw)
		elseif IsKRNL == true then
			DecodedScript = base64_decode(ScriptBase64)
			DecodedScript2 = base64_decode(ScriptBase64Raw)
	   else
			DecodedScript = syn.crypt.base64.decode(ScriptBase64)
            DecodedScript2 = syn.crypt.base64.decode(ScriptBase64Raw)
		end


		local ConfigVersion = 1

		local DefaultSettings = {
			Color = "184, 7, 53",
			AlreadyRan = false,
			ESPTracers = false,
			ESPBoxes = false,
			ESPNames = false,
			ESPEnabled = false,
			ConfigVersion = ConfigVersion,
		}

		--Functions
		--Torso getter
		function GetTorso(Player)
			if Player.Character then
				if Player.Character:FindFirstChild("UpperTorso") then
					return Player.Character.UpperTorso
				else
					return Player.Character.Torso
				end
			end
		end

		--UI library, not made by me, not a single part of it! All credits for it go to dawid on V3rm!!!!!!
		local Flux = loadstring(
			game:HttpGet("https://raw.githubusercontent.com/MegamiShin/UI-Librarys/main/fluxlib.txt")
		)()

		--Import Kiriot's ESP
		local ESP = loadstring(game:HttpGet("https://kiriot22.com/releases/ESP.lua"))()

		--Create a Boolvalue in the Coregui to show that T3PHUB is already loaded.
		local IsLoadedValue = Instance.new("BoolValue", CoreGui)
		IsLoadedValue.Name = "T3PHUBLoaded"
		IsLoadedValue.Value = true

		--Get the player's DisplayName
		local DisplayName = LocalPlayer.DisplayName

		--Create the T3PHUB folder if it doesn't already exist in the workspace.
		if not isfolder("T3PHUB") then
			makefolder("T3PHUB")
		end

		--Settings stuff
		if not isfile("T3PHUB/Settings.cfg") then
			delfolder("T3PHUB")
			makefolder("T3PHUB")
			writefile("T3PHUB/Settings.cfg", game:service("HttpService"):JSONEncode(DefaultSettings))
		end

		--Create a file containing the script if it already doesn't exist in the T3PHUB folder.

		if not isfile("T3PHUB/Script.lua") then
			writefile("T3PHUB/Script.lua", DecodedScript)
		end

		--More settings stuff
		Settings = game:service("HttpService"):JSONDecode(readfile("T3PHUB/Settings.cfg"))

		local function Save()
			writefile("T3PHUB/Settings.cfg", game:service("HttpService"):JSONEncode(Settings))
		end

		local RealColor = Settings.Color
		local TrueColor = string.split(RealColor, ", ")
		local TrulyFinalColor = Color3.fromRGB(tonumber(TrueColor[1]), tonumber(TrueColor[2]), tonumber(TrueColor[3]))

		--Create the main window
		local Mainframe = Flux:Window("T3PHUB", "Welcome, " .. DisplayName .. "!", TrulyFinalColor, Enum.KeyCode.End)

		--Check if this is the users first time running the GUI

		if Settings.ConfigVersion ~= ConfigVersion then
			Flux:Notification(
				"Outdated configuration detected, configuration erased. You will be rejoined in 5 seconds.",
				"sad"
			)
			delfolder("T3PHUB")
			wait(5)
			TeleportService:Teleport(game.PlaceId, LocalPlayer)
		end
		if Settings.AlreadyRan == false then
			Flux:Notification(
				"Welcome to T3PHUB! This hub has been made in the legacy of an old but useful GUI called T0PK3K. If you enjoy this, please leave a vouch and a honest review. Also, you can toggle the hub with the END key.",
				"Let's roll!"
			)
			Settings.AlreadyRan = true
			Save()
		else
		end

		--ESP stuff
		ESP.Players = Settings.ESPEnabled;
                ESP.Tracers = Settings.ESPTracers;
                ESP.Boxes = Settings.ESPBoxes;
                ESP.Names = Settings.ESPNames;
                ESP.TeamColor = true;
                ESP:Toggle(true)

		--Create the tabs

		local SelfTab = Mainframe:Tab("Self", "http://www.roblox.com/asset/?id=6023426915")
		local PlayersTab = Mainframe:Tab("Players", "http://www.roblox.com/asset/?id=5107183916")
		local MiscTab = Mainframe:Tab("Miscellaneous", "http://www.roblox.com/asset/?id=6022668888")
        local ESPTab = Mainframe:Tab("ESP", "http://www.roblox.com/asset/?id=8217650131")

         --Chat
		 local ChatTab = Mainframe:Tab("Chat", "http://www.roblox.com/asset/?id=7747965183")
		 local websocketfunc = syn and syn.websocket.connect or Krnl and Krnl.WebSocket.connect or WebSocket and WebSocket.connect or websocket and websocket.connect
		 local PORT = 5000
		 local WebSocket = websocketfunc("wss://not-exploiting-thing.glitch.me/"..PORT)
		 local ShowUsername = false
		 local Username = LocalPlayer.Name
		 WebSocket:Send(Username)
		 wait(.5)
		 ChatTab:Textbox("Write a message", "Create a new message that all hub users will see.", false, function(msg)
		if #msg >= 64 then return end
			 if ShowUsername == false then
				 WebSocket:Send([[{"message":"]]..msg..[[","hideName":true}]])
			 else
				 WebSocket:Send([[{"message":"]]..msg..[[","hideName":false}]])
			 end
		 end)
		 ChatTab:Toggle("Show username", "Don't want your username to be seen? No problem.", false, function(bool)
			 if bool then
				 ShowUsername = true
			 else
				 ShowUsername = false
			 end
		 end)
		 ChatTab:Line()
		 ChatTab:Label("Succesfully connected to the websocket!")
		 WebSocket.OnMessage:Connect(function(Msg)
			 local timestamp = os.date("%X", os.time())
			 ChatTab:Label(timestamp.." "..Msg)
		 end)
		 Websocket.OnClose:Connect(function()
			ChatTab:Label("The chat websocket has been closed, please reexecute the script.")
		 end)

        local SettingsTab = Mainframe:Tab("Settings", "http://www.roblox.com/asset/?id=5480743826")

		--Create labels
		SelfTab:Label("This tab has things that affect only you.")
		PlayersTab:Label("This tab has things that affect a certain player.")
		MiscTab:Label("This tab has some other useful stuff!")
		SettingsTab:Label("Please note that certain things save only after rejoin.")

		--BEGIN FEATURES

		--Speed change
		SelfTab:Slider("Walkspeed", "Choose your speed! Default is 16.", 0, 500, 16, function(speed)
			LocalPlayer.Character.Humanoid.WalkSpeed = speed
		end)

		--JumpHeight changer
		SelfTab:Slider("Jumppower", "Choose how high you wanna jump! Default is 50.", 0, 500, 50, function(jump)
			LocalPlayer.Character.Humanoid.UseJumpPower = true
			LocalPlayer.Character.Humanoid.JumpPower = jump
		end)

		--front tp

		local fronttp = 20
		SelfTab:Slider("Teleport facing power", "How many studs you should teleport when you use teleport facing feature", 0, 1000, 20, function(power)
			fronttp = power
		end)

		SelfTab:Line()

		--Teleport facing
		SelfTab:Button("Teleport facing", "Teleport to the location you're facing, adjust the power above.", function()
			game:GetService("Players").LocalPlayer.Character.PrimaryPart.CFrame += game:GetService("Players").LocalPlayer.Character.PrimaryPart.CFrame.LookVector * fronttp
		end)

		--Show backpack
        local IsBackPack = game.StarterGui:GetCoreGuiEnabled("Backpack")

		SelfTab:Toggle(
			"Toggle backpack",
			"Pesky game disabled your backpack? Just turn it back on! Or off, if that's what you need!",
			IsBackPack,
			function(t)
				if t == true then
					game.StarterGui:SetCoreGuiEnabled(Enum.CoreGuiType.Backpack, true)
				else
					game.StarterGui:SetCoreGuiEnabled(Enum.CoreGuiType.Backpack, false)
				end
			end
		)

		--Increase zoom distance
        local OldZoom = game.Players.LocalPlayer.CameraMaxZoomDistance

		SelfTab:Toggle("Increase zoom distance", "Need more zooming? No problem!", false, function()
            if game.Players.LocalPlayer.CameraMaxZoomDistance == 1000 then
                game.Players.LocalPlayer.CameraMaxZoomDistance = OldZoom
            else
			    game.Players.LocalPlayer.CameraMaxZoomDistance = 1000
            end
		end)


        local LockedWS = true
		MiscTab:Toggle("Unlock workspace", "Workspace is locked and you can't delete stuff? Just unlock it!", false, function()
			function UnlockEverything(main)
				for _, v in pairs(main:GetChildren()) do
					if v:IsA("Part") then
						v.Locked = false
					end
					UnlockEverything(v)
				end
			end
            function LockEverything(main)
				for _, v in pairs(main:GetChildren()) do
					if v:IsA("Part") then
						v.Locked = true
					end
					LockEverything(v)
				end
			end
            if LockedWS == true then
			UnlockEverything(game.Workspace)
            LockedWS = false
            else
            LockEverything(game.Workspace)
            LockedWS = true
            end
		end)

		MiscTab:Line()

		--Rejoin same server
		MiscTab:Button("Rejoin", "Rejoin the same server you are in!", function()
			TeleportService:Teleport(game.PlaceId, LocalPlayer)
		end)

		--Saveinstance
		MiscTab:Button("Save the game", "Save the games files to the workspace folder.", function()
			saveinstance()
		end)

		--Color changer
		SettingsTab:Colorpicker("Hub Color", TrulyFinalColor, function(t)
			--Convert Color3 to Color3.fromRGB for easier manipulation
			local r, g, b = math.round(t.R * 255), math.round(t.G * 255), math.round(t.B * 255)
			local RGB_Color = Color3.new(r, g, b)
			Settings.Color = tostring(RGB_Color)
			Save()
		end)

		--ESP Toggler
		ESPTab:Button("Toggle ESP", "Either enable or disable ESP.", function()
			if Settings.ESPEnabled == true then
				Settings.ESPEnabled = false
				ESP.Players = false
			else
				Settings.ESPEnabled = true
				ESP.Players = true
			end

			Save()
		end)

		ESPTab:Line()

		--ESP tracer Toggler
		ESPTab:Button(
			"Toggle ESP Tracers",
			"Either enable or disable ESP tracers. This will only properly apply after rejoin.",
			function()
				if Settings.ESPTracers == true then
					Settings.ESPTracers = false
					Flux:Notification("ESP Tracers will be disabled on your next rejoin.", "Great!")
				else
					Settings.ESPTracers = true
					Flux:Notification("ESP Tracers will be enabled on your next rejoin.", "Great!")
				end

				Save()
			end
		)

		--ESP box Toggler
		ESPTab:Button(
			"Toggle ESP Boxes",
			"Either enable or disable ESP boxes. This will only properly apply after rejoin.",
			function()
				if Settings.ESPBoxes == true then
					Settings.ESPBoxes = false
					Flux:Notification("ESP Boxes will be disabled on your next rejoin.", "Great!")
				else
					Settings.ESPBoxes = true
					Flux:Notification("ESP Boxes will be enabled on your next rejoin.", "Great!")
				end

				Save()
			end
		)

		--ESP name Toggler
		ESPTab:Button(
			"Toggle ESP Names",
			"Either enable or disable ESP names. This will only properly apply after rejoin.",
			function()
				if Settings.ESPNames == true then
					Settings.ESPNames = false
					Flux:Notification("ESP Names will be disabled on your next rejoin.", "Great!")
				else
					Settings.ESPNames = true
					Flux:Notification("ESP Names will be enabled on your next rejoin.", "Great!")
				end

				Save()
			end
		)

		--Discord join
		if syn then
			SettingsTab:Button(
				"Join Discord",
				"Do you want to be updated on T3PHUB? Click here to join our Discord! It really means a lot.",
				function()
					syn.request({
						Url = "http://127.0.0.1:6463/rpc?v=1",
						Method = "POST",
						Headers = {
							["Content-Type"] = "application/json",
							["Origin"] = "https://discord.com",
						},
						Body = game:GetService("HttpService"):JSONEncode({
							cmd = "INVITE_BROWSER",
							args = {
								code = "XquAX54xmP",
							},
							nonce = game:GetService("HttpService"):GenerateGUID(false),
						}),
					})
				end
			)
		end

		SettingsTab:Line()

		--Purge config
		SettingsTab:Button(
			"Purge T3PHUB configration",
			"Delete ABSOLUTELY ALL records of T3PHUB usage on your computer. This is irreversible, and you will be rejoined.",
			function()
				delfolder("T3PHUB")
                Flux:Notification("T3PHUB configuration purged, you are being rejoined...")
                wait(5)
				TeleportService:Teleport(game.PlaceId, LocalPlayer)
			end
		)

		--ServerHop
		MiscTab:Button(
			"Serverhop",
			"Join a different server in the same game.",
			function() --Script created by CharWar on V3rmillion
				loadstring(
					game:HttpGet(
						"https://raw.githubusercontent.com/MegamiShin/Exploit-Scripts/main/Assets/NotMine/ServerHopper.lua"
					)
				)()
			end
		)

		--Ctrl + Click Teleport
        local ctrltpenabled = false

		SelfTab:Toggle(
			"CTRL + Click teleport",
			"Hold CTRL and click to teleport to where your mouse is pointing at!",
            false,
			function()
                if ctrltpenabled == false then
                    ctrltpenabled = true
                else
                    ctrltpenabled = false
                end

				local Mouse = LocalPlayer:GetMouse()

				Mouse.Button1Down:Connect(function()
                    if ctrltpenabled == true then
					if not game:GetService("UserInputService"):IsKeyDown(Enum.KeyCode.LeftControl) then
						return
					end
					LocalPlayer.Character:MoveTo(Mouse.Hit.p)
                end
				end)
			end
		)

		--ALT + Click delete
        local altdeleteenabled = false

		SelfTab:Toggle(
			"ALT + Click delete",
			"Hold ALT and click to delete a wall, or anything really that your mouse is pointing at!",
            false,
			function()
                if altdeleteenabled == false then
                altdeleteenabled = true
                else
                altdeleteenabled = false
                end
				local Mouse = LocalPlayer:GetMouse()

				Mouse.Button1Down:Connect(function()
                    if altdeleteenabled == true then
					if not game:GetService("UserInputService"):IsKeyDown(Enum.KeyCode.LeftAlt) then
						return
					end
					if not Mouse.Target then
						return
					end
					Mouse.Target:Destroy()
				end
			end)
        end
		)

		--Suicide
		SelfTab:Bind("Suicide Bind", Enum.KeyCode.Z, function()
			LocalPlayer.Character.Head:Destroy()
		end)

		SelfTab:Line()

		--DANGER ZONE SELF TAB
		SelfTab:Label("DANGER ZONE: USE WITH CAUTION")

		--Get BTools
        local hasbtools = false

		SelfTab:Toggle("Get BTools", "Get building tools. CTRL + Click delete is a MUCH safer alternative.", false, function(t)
            if hasbtools == false then
                hasbtools = true
            else
                hasbtools = false
            end

            if hasbtools == true then
			--Game tool
			local GameTool = Instance.new("HopperBin")
			GameTool.BinType = "GameTool"
			GameTool.Parent = LocalPlayer.Backpack

			--Clone tool
			local CloneTool = Instance.new("HopperBin")
			CloneTool.BinType = "Clone"
			CloneTool.Parent = LocalPlayer.Backpack

			--Hammer tool
			local HammerTool = Instance.new("HopperBin")
			HammerTool.BinType = "Hammer"
			HammerTool.Parent = LocalPlayer.Backpack
            else
                for i,v in pairs(LocalPlayer.Backpack:GetChildren()) do
                if v.Name == "HopperBin" then
                    v:Destroy()
                end
                end
        end
		end)

		--Fly
		SelfTab:Toggle(
			"Fly",
			"Need to fly around the map? Go ahead! WARNING: This MAY be bannable in some games!",
			false,
			function()
				if Fly == true then
					Fly = false

					return
				end

				Fly = true

				local Mouse = game.Players.LocalPlayer:GetMouse()

				LocalPlayer = game.Players.LocalPlayer

				local HumanoidRootPart = LocalPlayer.Character:WaitForChild("HumanoidRootPart")

				local Speed = 0

				local Keys = { a = false, d = false, w = false, s = false }

				local e1

				local e2

				local function Begin()
					local pos = Instance.new("BodyPosition", HumanoidRootPart)

					local gyro = Instance.new("BodyGyro", HumanoidRootPart)

					pos.Name = "nothinggyro"

					pos.maxForce = Vector3.new(math.huge, math.huge, math.huge)

					pos.position = HumanoidRootPart.Position

					gyro.maxTorque = Vector3.new(9e9, 9e9, 9e9)

					gyro.cframe = HumanoidRootPart.CFrame

					repeat
						wait()

						LocalPlayer.Character.Humanoid.PlatformStand = true

						local new = gyro.cframe - gyro.cframe.p + pos.position

						if not Keys.w and not Keys.s and not Keys.a and not Keys.d then
							Speed = 1
						end

						if Keys.w then
							new = new + workspace.CurrentCamera.CoordinateFrame.lookVector * Speed

							Speed = Speed + 0.01
						end

						if Keys.s then
							new = new - workspace.CurrentCamera.CoordinateFrame.lookVector * Speed

							Speed = Speed + 0.01
						end

						if Keys.d then
							new = new * CFrame.new(Speed, 0, 0)

							Speed = Speed + 0.01
						end

						if Keys.a then
							new = new * CFrame.new(-Speed, 0, 0)

							Speed = Speed + 0.01
						end

						if Speed > 5 then
							Speed = 5
						end

						pos.position = new.p

						if Keys.w then
							gyro.cframe = workspace.CurrentCamera.CoordinateFrame
								* CFrame.Angles(-math.rad(Speed * 15), 0, 0)
						elseif Keys.s then
							gyro.cframe = workspace.CurrentCamera.CoordinateFrame
								* CFrame.Angles(math.rad(Speed * 15), 0, 0)
						else
							gyro.cframe = workspace.CurrentCamera.CoordinateFrame
						end

					until not Fly

					if gyro then
						gyro:Destroy()
					end

					if pos then
						pos:Destroy()
					end

					flying = false

					LocalPlayer.Character.Humanoid.PlatformStand = false

					Speed = 0
				end

				e1 = Mouse.KeyDown:connect(function(key)
					if not HumanoidRootPart or not HumanoidRootPart.Parent then
						flying = false
						e1:disconnect()
						e2:disconnect()
						return
					end

					if key == "w" then
						Keys.w = true
					elseif key == "s" then
						Keys.s = true
					elseif key == "a" then
						Keys.a = true
					elseif key == "d" then
						Keys.d = true
					end
				end)

				e2 = Mouse.KeyUp:connect(function(key)
					if key == "w" then
						Keys.w = false
					elseif key == "s" then
						Keys.s = false
					elseif key == "a" then
						Keys.a = false
					elseif key == "d" then
						Keys.d = false
					end
				end)

				Begin()
			end
		)

		--Player tab create dropdown
		local PlayerTable = {}
		local PlayersDropdown = PlayersTab:Dropdown("Choose a player", PlayerTable, function(t)
			ChosenPlayer = t
			ChosenPlayerInstance = Players:FindFirstChild(t)
			ChosenPlayerCharacter = ChosenPlayerInstance.Character
		end)

		PlayersTab:Line()

		PlayersTab:Button("Teleport to", "Teleport yourself to the selected player", function()
			if ChosenPlayer then
				LocalPlayer.Character.HumanoidRootPart.CFrame = ChosenPlayerCharacter.HumanoidRootPart.CFrame
			end
		end)

		PlayersTab:Toggle("View", "Spectate the player", false, function(t)
			if t == true then
				if ChosenPlayer then
					game.Workspace.Camera.CameraSubject = ChosenPlayerCharacter.Humanoid
				end
			else
				game.Workspace.Camera.CameraSubject = LocalPlayer.Character.Humanoid
			end
		end)

		--Player table filler
		local function UpdateDropdown()
			--Clear the table
			table.clear(PlayerTable)

			--Compile list of players into a table
			for i, v in pairs(Players:GetPlayers()) do
				table.insert(PlayerTable, v.Name)
			end

			--Clear the Dropdown
			PlayersDropdown:Clear()

			--Fill in the Dropdown
			for i, v in pairs(PlayerTable) do
				PlayersDropdown:Add(v)
			end
		end
		UpdateDropdown()

		Players.PlayerAdded:Connect(function()
			UpdateDropdown()
		end)

		Players.PlayerRemoving:Connect(function()
			wait(1.5)
			UpdateDropdown()
		end)
	end
end
